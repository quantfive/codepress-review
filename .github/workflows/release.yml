name: Release

on:
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Mark as pre-release (beta)"
        required: false
        type: boolean
        default: false
      branch:
        description: "Branch to release from (for pre-releases)"
        required: false
        type: string
        default: "main"

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed) or if manually triggered
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for tags and commit analysis
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm run build

      - name: Determine version bump type
        id: version_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use provided input
            echo "bump_type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
            echo "Using manual version type: ${{ github.event.inputs.version_type }}"
          else
            # Check PR labels for version type
            LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
            echo "PR Labels: $LABELS"

            if echo "$LABELS" | grep -q "release:major"; then
              BUMP="major"
              echo "Found release:major label"
            elif echo "$LABELS" | grep -q "release:minor"; then
              BUMP="minor"
              echo "Found release:minor label"
            elif echo "$LABELS" | grep -q "release:patch"; then
              BUMP="patch"
              echo "Found release:patch label"
            else
              # Default to patch if no release label
              BUMP="patch"
              echo "No release label found, defaulting to patch"
            fi

            echo "bump_type=$BUMP" >> $GITHUB_OUTPUT
            echo "Version bump type: $BUMP"
          fi

      - name: Get latest version tag
        id: get_version
        run: |
          LATEST_TAG=$(git tag -l "v*.*.*" --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing version tags found. Starting from v0.0.0"
            LATEST_TAG="v0.0.0"
          fi

          echo "Latest tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # Parse version components
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          echo "Current version: $MAJOR.$MINOR.$PATCH"
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: new_version
        run: |
          MAJOR=${{ steps.get_version.outputs.major }}
          MINOR=${{ steps.get_version.outputs.minor }}
          PATCH=${{ steps.get_version.outputs.patch }}
          BUMP_TYPE=${{ steps.version_type.outputs.bump_type }}
          IS_PRERELEASE=${{ github.event.inputs.prerelease }}

          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          if [ "$IS_PRERELEASE" = "true" ]; then
            # Find the highest existing beta number for this version
            BASE_VERSION="v$MAJOR.$MINOR.$PATCH"
            EXISTING_BETAS=$(git tag -l "${BASE_VERSION}-beta.*" | grep -oE 'beta\.[0-9]+' | grep -oE '[0-9]+' | sort -n | tail -1)

            if [ -z "$EXISTING_BETAS" ]; then
              BETA_NUMBER=1
            else
              BETA_NUMBER=$((EXISTING_BETAS + 1))
            fi

            NEW_VERSION="${BASE_VERSION}-beta.${BETA_NUMBER}"
            echo "Creating beta version: $NEW_VERSION (auto-incremented)"
          else
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
            echo "Creating release version: $NEW_VERSION"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "major_version=v$MAJOR" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update package.json version (stable releases only)
        if: steps.new_version.outputs.is_prerelease != 'true'
        run: |
          NEW_VERSION=${{ steps.new_version.outputs.new_version }}
          # Remove 'v' prefix for package.json
          VERSION_NUMBER=${NEW_VERSION#v}
          npm version $VERSION_NUMBER --no-git-tag-version

      - name: Commit and push release changes (stable releases only)
        if: steps.new_version.outputs.is_prerelease != 'true'
        run: |
          git add package.json
          git commit -m "Bump version to ${{ steps.new_version.outputs.new_version }}" || echo "No changes to commit"
          git push origin main

          # Now add dist/ for the tag (not pushed to main)
          git add -f dist/
          git commit -m "Build dist for ${{ steps.new_version.outputs.new_version }}" || echo "No changes to commit"

      - name: Prepare prerelease build (beta releases only)
        if: steps.new_version.outputs.is_prerelease == 'true'
        run: |
          # For prereleases, just add dist/ without pushing to main
          git add -f dist/
          git commit -m "Build dist for ${{ steps.new_version.outputs.new_version }}" || echo "No changes to commit"

      - name: Create and push tag
        run: |
          NEW_VERSION=${{ steps.new_version.outputs.new_version }}

          echo "Creating tag $NEW_VERSION..."
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"

          echo "Tag $NEW_VERSION created and pushed"

      - name: Update major version tag (stable releases only)
        if: steps.new_version.outputs.is_prerelease != 'true'
        run: |
          MAJOR_VERSION=${{ steps.new_version.outputs.major_version }}
          echo "Updating major version tag $MAJOR_VERSION..."

          git tag -f "$MAJOR_VERSION"
          git push origin "$MAJOR_VERSION" --force

          echo "Major version tag $MAJOR_VERSION updated"

      - name: Generate release notes
        id: release_notes
        run: |
          LATEST_TAG=${{ steps.get_version.outputs.latest_tag }}
          NEW_VERSION=${{ steps.new_version.outputs.new_version }}

          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md

          if [ "$LATEST_TAG" != "v0.0.0" ]; then
            echo "### Commits since $LATEST_TAG" >> release_notes.md
            echo "" >> release_notes.md
            git log --oneline $LATEST_TAG..HEAD 2>/dev/null | head -20 >> release_notes.md || echo "See commit history for changes." >> release_notes.md
          else
            echo "Initial release" >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$LATEST_TAG...$NEW_VERSION" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.new_version.outputs.new_version }}
          name: ${{ steps.new_version.outputs.new_version }}
          body_path: release_notes.md
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          IS_PRERELEASE=${{ steps.new_version.outputs.is_prerelease }}

          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "## ðŸ§ª Beta Release Created!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Type:** ${{ steps.version_type.outputs.bump_type }} (prerelease)" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.event.inputs.branch || 'main' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Testing this beta" >> $GITHUB_STEP_SUMMARY
            echo "Use in your workflow:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            echo "uses: quantfive/codepress-review@${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸš€ Release Created!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Type:** ${{ steps.version_type.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
            echo "**Major Tag:** ${{ steps.new_version.outputs.major_version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Users can now use \`quantfive/codepress-review@${{ steps.new_version.outputs.major_version }}\` or \`quantfive/codepress-review@${{ steps.new_version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          fi
